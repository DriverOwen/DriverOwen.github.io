function L2DBaseModel(){this.live2DModel=null,this.modelMatrix=null,this.eyeBlink=null,this.physics=null,this.pose=null,this.debugMode=!1,this.initialized=!1,this.updating=!1,this.alpha=1,this.accAlpha=0,this.lipSync=!1,this.lipSyncValue=0,this.accelX=0,this.accelY=0,this.accelZ=0,this.dragX=0,this.dragY=0,this.startTimeMSec=null,this.mainMotionManager=new L2DMotionManager,this.expressionManager=new L2DMotionManager,this.motions={},this.expressions={},this.isTexLoaded=!1}var texCounter=0;function L2DExpressionMotion(){AMotion.prototype.constructor.call(this),this.paramList=new Array}function L2DExpressionParam(){this.id="",this.type=-1,this.value=null}function L2DEyeBlink(){this.nextBlinkTime=null,this.stateStartTime=null,this.blinkIntervalMsec=null,this.eyeState=EYE_STATE.STATE_FIRST,this.blinkIntervalMsec=4e3,this.closingMotionMsec=100,this.closedMotionMsec=50,this.openingMotionMsec=150,this.closeIfZero=!0,this.eyeID_L="PARAM_EYE_L_OPEN",this.eyeID_R="PARAM_EYE_R_OPEN"}L2DBaseModel.prototype.getModelMatrix=function(){return this.modelMatrix},L2DBaseModel.prototype.setAlpha=function(t){.999<t&&(t=1),t<.001&&(t=0),this.alpha=t},L2DBaseModel.prototype.getAlpha=function(){return this.alpha},L2DBaseModel.prototype.isInitialized=function(){return this.initialized},L2DBaseModel.prototype.setInitialized=function(t){this.initialized=t},L2DBaseModel.prototype.isUpdating=function(){return this.updating},L2DBaseModel.prototype.setUpdating=function(t){this.updating=t},L2DBaseModel.prototype.getLive2DModel=function(){return this.live2DModel},L2DBaseModel.prototype.setLipSync=function(t){this.lipSync=t},L2DBaseModel.prototype.setLipSyncValue=function(t){this.lipSyncValue=t},L2DBaseModel.prototype.setAccel=function(t,e,i){this.accelX=t,this.accelY=e,this.accelZ=i},L2DBaseModel.prototype.setDrag=function(t,e){this.dragX=t,this.dragY=e},L2DBaseModel.prototype.getMainMotionManager=function(){return this.mainMotionManager},L2DBaseModel.prototype.getExpressionManager=function(){return this.expressionManager},L2DBaseModel.prototype.loadModelData=function(t,e){var i=Live2DFramework.getPlatformManager();this.debugMode&&i.log("Load model : "+t);var r=this;i.loadLive2DModel(t,function(t){r.live2DModel=t,r.live2DModel.saveParam(),0==Live2D.getError()?(r.modelMatrix=new L2DModelMatrix(r.live2DModel.getCanvasWidth(),r.live2DModel.getCanvasHeight()),r.modelMatrix.setWidth(2),r.modelMatrix.setCenterPosition(0,0),e(r.live2DModel)):console.error("Error : Failed to loadModelData().")})},L2DBaseModel.prototype.loadTexture=function(t,e,i){texCounter++;var r=Live2DFramework.getPlatformManager();this.debugMode&&r.log("Load Texture : "+e);var o=this;r.loadTexture(this.live2DModel,t,e,function(){0==--texCounter&&(o.isTexLoaded=!0),"function"==typeof i&&i()})},L2DBaseModel.prototype.loadMotion=function(e,t,i){var r=Live2DFramework.getPlatformManager();this.debugMode&&r.log("Load Motion : "+t);var o=null,a=this;r.loadBytes(t,function(t){o=Live2DMotion.loadMotion(t),null!=e&&(a.motions[e]=o),i(o)})},L2DBaseModel.prototype.loadExpression=function(e,t,i){var r=Live2DFramework.getPlatformManager();this.debugMode&&r.log("Load Expression : "+t);var o=this;r.loadBytes(t,function(t){null!=e&&(o.expressions[e]=L2DExpressionMotion.loadJson(t)),"function"==typeof i&&i()})},L2DBaseModel.prototype.loadPose=function(t,e){var i=Live2DFramework.getPlatformManager();this.debugMode&&i.log("Load Pose : "+t);var r=this;try{i.loadBytes(t,function(t){r.pose=L2DPose.load(t),"function"==typeof e&&e()})}catch(t){console.warn(t)}},L2DBaseModel.prototype.loadPhysics=function(t){var e=Live2DFramework.getPlatformManager();this.debugMode&&e.log("Load Physics : "+t);var i=this;try{e.loadBytes(t,function(t){i.physics=L2DPhysics.load(t)})}catch(t){console.warn(t)}},L2DBaseModel.prototype.hitTestSimple=function(t,e,i){var r=this.live2DModel.getDrawDataIndex(t);if(r<0)return!1;for(var o=this.live2DModel.getTransformedPoints(r),a=this.live2DModel.getCanvasWidth(),s=0,n=this.live2DModel.getCanvasHeight(),h=0,l=0;l<o.length;l+=2){var p=o[l],c=o[l+1];p<a&&(a=p),s<p&&(s=p),c<n&&(n=c),h<c&&(h=c)}var u=this.modelMatrix.invertTransformX(e),M=this.modelMatrix.invertTransformY(i);return console.log("XOWEN"+(a<=u&&u<=s&&n<=M&&M<=h)),a<=u&&u<=s&&n<=M&&M<=h},L2DExpressionMotion.prototype=new AMotion,L2DExpressionMotion.EXPRESSION_DEFAULT="DEFAULT",L2DExpressionMotion.TYPE_SET=0,L2DExpressionMotion.TYPE_ADD=1,L2DExpressionMotion.TYPE_MULT=2,L2DExpressionMotion.loadJson=function(t){var e=new L2DExpressionMotion,i=Live2DFramework.getPlatformManager().jsonParseFromBytes(t);if(e.setFadeIn(0<parseInt(i.fade_in)?parseInt(i.fade_in):1e3),e.setFadeOut(0<parseInt(i.fade_out)?parseInt(i.fade_out):1e3),null==i.params)return e;var r=i.params,o=r.length;e.paramList=[];for(var a=0;a<o;a++){var s,n=r[a],h=n.id.toString(),l=parseFloat(n.val),p=L2DExpressionMotion.TYPE_ADD,c=null!=n.calc?n.calc.toString():"add";(p="add"===c?L2DExpressionMotion.TYPE_ADD:"mult"===c?L2DExpressionMotion.TYPE_MULT:"set"===c?L2DExpressionMotion.TYPE_SET:L2DExpressionMotion.TYPE_ADD)==L2DExpressionMotion.TYPE_ADD?l-=s=null==n.def?0:parseFloat(n.def):p==L2DExpressionMotion.TYPE_MULT&&(0==(s=null==n.def?1:parseFloat(n.def))&&(s=1),l/=s);var u=new L2DExpressionParam;u.id=h,u.type=p,u.value=l,e.paramList.push(u)}return e},L2DExpressionMotion.prototype.updateParamExe=function(t,e,i,r){for(var o=this.paramList.length-1;0<=o;--o){var a=this.paramList[o];a.type==L2DExpressionMotion.TYPE_ADD?t.addToParamFloat(a.id,a.value,i):a.type==L2DExpressionMotion.TYPE_MULT?t.multParamFloat(a.id,a.value,i):a.type==L2DExpressionMotion.TYPE_SET&&t.setParamFloat(a.id,a.value,i)}},L2DEyeBlink.prototype.calcNextBlink=function(){return UtSystem.getUserTimeMSec()+Math.random()*(2*this.blinkIntervalMsec-1)},L2DEyeBlink.prototype.setInterval=function(t){this.blinkIntervalMsec=t},L2DEyeBlink.prototype.setEyeMotion=function(t,e,i){this.closingMotionMsec=t,this.closedMotionMsec=e,this.openingMotionMsec=i},L2DEyeBlink.prototype.updateParam=function(t){var e,i=UtSystem.getUserTimeMSec(),r=0;switch(this.eyeState){case EYE_STATE.STATE_CLOSING:1<=(r=(i-this.stateStartTime)/this.closingMotionMsec)&&(r=1,this.eyeState=EYE_STATE.STATE_CLOSED,this.stateStartTime=i),e=1-r;break;case EYE_STATE.STATE_CLOSED:1<=(r=(i-this.stateStartTime)/this.closedMotionMsec)&&(this.eyeState=EYE_STATE.STATE_OPENING,this.stateStartTime=i),e=0;break;case EYE_STATE.STATE_OPENING:1<=(r=(i-this.stateStartTime)/this.openingMotionMsec)&&(r=1,this.eyeState=EYE_STATE.STATE_INTERVAL,this.nextBlinkTime=this.calcNextBlink()),e=r;break;case EYE_STATE.STATE_INTERVAL:this.nextBlinkTime<i&&(this.eyeState=EYE_STATE.STATE_CLOSING,this.stateStartTime=i),e=1;break;case EYE_STATE.STATE_FIRST:default:this.eyeState=EYE_STATE.STATE_INTERVAL,this.nextBlinkTime=this.calcNextBlink(),e=1}this.closeIfZero||(e=-e),t.setParamFloat(this.eyeID_L,e),t.setParamFloat(this.eyeID_R,e)};var EYE_STATE=function(){};function L2DMatrix44(){this.tr=new Float32Array(16),this.identity()}function L2DModelMatrix(t,e){L2DMatrix44.prototype.constructor.call(this),this.width=t,this.height=e}function L2DMotionManager(){MotionQueueManager.prototype.constructor.call(this),this.currentPriority=null,this.reservePriority=null,this.super=MotionQueueManager.prototype}function L2DPhysics(){this.physicsList=new Array,this.startTimeMSec=UtSystem.getUserTimeMSec()}function L2DPose(){this.lastTime=0,this.lastModel=null,this.partsGroups=new Array}function L2DPartsParam(t){this.paramIndex=-1,this.partsIndex=-1,this.link=null,this.id=t}function L2DTargetPoint(){this.faceTargetX=0,this.faceTargetY=0,this.faceX=0,this.faceY=0,this.faceVX=0,this.faceVY=0,this.lastTimeSec=0}function L2DViewMatrix(){L2DMatrix44.prototype.constructor.call(this),this.screenLeft=null,this.screenRight=null,this.screenTop=null,this.screenBottom=null,this.maxLeft=null,this.maxRight=null,this.maxTop=null,this.maxBottom=null,this.max=Number.MAX_VALUE,this.min=0}function Live2DFramework(){}EYE_STATE.STATE_FIRST="STATE_FIRST",EYE_STATE.STATE_INTERVAL="STATE_INTERVAL",EYE_STATE.STATE_CLOSING="STATE_CLOSING",EYE_STATE.STATE_CLOSED="STATE_CLOSED",EYE_STATE.STATE_OPENING="STATE_OPENING",L2DMatrix44.mul=function(t,e,i){for(var r,o,a=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],s=0;s<4;s++)for(r=0;r<4;r++)for(o=0;o<4;o++)a[s+4*r]+=t[s+4*o]*e[o+4*r];for(s=0;s<16;s++)i[s]=a[s]},L2DMatrix44.prototype.identity=function(){for(var t=0;t<16;t++)this.tr[t]=t%5==0?1:0},L2DMatrix44.prototype.getArray=function(){return this.tr},L2DMatrix44.prototype.getCopyMatrix=function(){return new Float32Array(this.tr)},L2DMatrix44.prototype.setMatrix=function(t){if(null!=this.tr&&this.tr.length==this.tr.length)for(var e=0;e<16;e++)this.tr[e]=t[e]},L2DMatrix44.prototype.getScaleX=function(){return this.tr[0]},L2DMatrix44.prototype.getScaleY=function(){return this.tr[5]},L2DMatrix44.prototype.transformX=function(t){return this.tr[0]*t+this.tr[12]},L2DMatrix44.prototype.transformY=function(t){return this.tr[5]*t+this.tr[13]},L2DMatrix44.prototype.invertTransformX=function(t){return(t-this.tr[12])/this.tr[0]},L2DMatrix44.prototype.invertTransformY=function(t){return(t-this.tr[13])/this.tr[5]},L2DMatrix44.prototype.multTranslate=function(t,e){var i=[1,0,0,0,0,1,0,0,0,0,1,0,t,e,0,1];L2DMatrix44.mul(i,this.tr,this.tr)},L2DMatrix44.prototype.translate=function(t,e){this.tr[12]=t,this.tr[13]=e},L2DMatrix44.prototype.translateX=function(t){this.tr[12]=t},L2DMatrix44.prototype.translateY=function(t){this.tr[13]=t},L2DMatrix44.prototype.multScale=function(t,e){var i=[t,0,0,0,0,e,0,0,0,0,1,0,0,0,0,1];L2DMatrix44.mul(i,this.tr,this.tr)},L2DMatrix44.prototype.scale=function(t,e){this.tr[0]=t,this.tr[5]=e},L2DModelMatrix.prototype=new L2DMatrix44,L2DModelMatrix.prototype.setPosition=function(t,e){this.translate(t,e)},L2DModelMatrix.prototype.setCenterPosition=function(t,e){var i=this.width*this.getScaleX(),r=this.height*this.getScaleY();this.translate(t-i/2,e-r/2)},L2DModelMatrix.prototype.top=function(t){this.setY(t)},L2DModelMatrix.prototype.bottom=function(t){var e=this.height*this.getScaleY();this.translateY(t-e)},L2DModelMatrix.prototype.left=function(t){this.setX(t)},L2DModelMatrix.prototype.right=function(t){var e=this.width*this.getScaleX();this.translateX(t-e)},L2DModelMatrix.prototype.centerX=function(t){var e=this.width*this.getScaleX();this.translateX(t-e/2)},L2DModelMatrix.prototype.centerY=function(t){var e=this.height*this.getScaleY();this.translateY(t-e/2)},L2DModelMatrix.prototype.setX=function(t){this.translateX(t)},L2DModelMatrix.prototype.setY=function(t){this.translateY(t)},L2DModelMatrix.prototype.setHeight=function(t){var e=t/this.height,i=-e;this.scale(e,i)},L2DModelMatrix.prototype.setWidth=function(t){var e=t/this.width,i=-e;this.scale(e,i)},L2DMotionManager.prototype=new MotionQueueManager,L2DMotionManager.prototype.getCurrentPriority=function(){return this.currentPriority},L2DMotionManager.prototype.getReservePriority=function(){return this.reservePriority},L2DMotionManager.prototype.reserveMotion=function(t){return!(this.reservePriority>=t||this.currentPriority>=t||(this.reservePriority=t,0))},L2DMotionManager.prototype.setReservePriority=function(t){this.reservePriority=t},L2DMotionManager.prototype.updateParam=function(t){var e=MotionQueueManager.prototype.updateParam.call(this,t);return this.isFinished()&&(this.currentPriority=0),e},L2DMotionManager.prototype.startMotionPrio=function(t,e){return e==this.reservePriority&&(this.reservePriority=0),this.currentPriority=e,this.startMotion(t,!1)},L2DPhysics.load=function(t){for(var e=new L2DPhysics,i=Live2DFramework.getPlatformManager().jsonParseFromBytes(t).physics_hair,r=i.length,o=0;o<r;o++){var a=i[o],s=new PhysicsHair,n=a.setup,h=parseFloat(n.length),l=parseFloat(n.regist),p=parseFloat(n.mass);s.setup(h,l,p);for(var c=a.src,u=c.length,M=0;M<u;M++){var f=c[M],L=f.id,y=PhysicsHair.Src.SRC_TO_X;"x"===(m=f.ptype)?y=PhysicsHair.Src.SRC_TO_X:"y"===m?y=PhysicsHair.Src.SRC_TO_Y:"angle"===m?y=PhysicsHair.Src.SRC_TO_G_ANGLE:UtDebug.error("live2d","Invalid parameter:PhysicsHair.Src");var D=parseFloat(f.scale),d=parseFloat(f.weight);s.addSrcParam(y,L,D,d)}for(var g=a.targets,T=g.length,M=0;M<T;M++){var m,x=g[M],L=x.id,y=PhysicsHair.Target.TARGET_FROM_ANGLE;"angle"===(m=x.ptype)?y=PhysicsHair.Target.TARGET_FROM_ANGLE:"angle_v"===m?y=PhysicsHair.Target.TARGET_FROM_ANGLE_V:UtDebug.error("live2d","Invalid parameter:PhysicsHair.Target"),D=parseFloat(x.scale),d=parseFloat(x.weight),s.addTargetParam(y,L,D,d)}e.physicsList.push(s)}return e},L2DPhysics.prototype.updateParam=function(t){for(var e=UtSystem.getUserTimeMSec()-this.startTimeMSec,i=0;i<this.physicsList.length;i++)this.physicsList[i].update(t,e)},L2DPose.load=function(t){for(var e=new L2DPose,i=Live2DFramework.getPlatformManager().jsonParseFromBytes(t).parts_visible,r=i.length,o=0;o<r;o++){for(var a=i[o].group,s=a.length,n=new Array,h=0;h<s;h++){var l=a[h],p=new L2DPartsParam(l.id);if(n[h]=p,null!=l.link){var c=l.link,u=c.length;p.link=new Array;for(var M=0;M<u;M++){var f=new L2DPartsParam(c[M]);p.link.push(f)}}}e.partsGroups.push(n)}return e},L2DPose.prototype.updateParam=function(t){if(null!=t){t!=this.lastModel&&this.initParam(t),this.lastModel=t;var e=UtSystem.getTimeMSec(),i=0==this.lastTime?0:(e-this.lastTime)/1e3;this.lastTime=e,i<0&&(i=0);for(var r=0;r<this.partsGroups.length;r++)this.normalizePartsOpacityGroup(t,this.partsGroups[r],i),this.copyOpacityOtherParts(t,this.partsGroups[r])}},L2DPose.prototype.initParam=function(t){if(null!=t)for(var e=0;e<this.partsGroups.length;e++)for(var i=this.partsGroups[e],r=0;r<i.length;r++){i[r].initIndex(t);var o=i[r].partsIndex,a=i[r].paramIndex;if(!(o<0)){var s=0!=t.getParamFloat(a);if(t.setPartsOpacity(o,s?1:0),t.setParamFloat(a,s?1:0),null!=i[r].link)for(var n=0;n<i[r].link.length;n++)i[r].link[n].initIndex(t)}}},L2DPose.prototype.normalizePartsOpacityGroup=function(t,e,i){for(var r=-1,o=1,a=0;a<e.length;a++){var s=e[a].partsIndex,n=e[a].paramIndex;if(!(s<0)&&0!=t.getParamFloat(n)){if(0<=r)break;r=a,o=t.getPartsOpacity(s),1<(o+=i/.5)&&(o=1)}}r<0&&(r=0,o=1);for(var h,l,a=0;a<e.length;a++)(s=e[a].partsIndex)<0||(r==a?t.setPartsOpacity(s,o):(.15<(1-(l=o<.5?-.5*o/.5+1:.5*(1-o)/.5))*(1-o)&&(l=1-.15/(1-o)),l<(h=t.getPartsOpacity(s))&&(h=l),t.setPartsOpacity(s,h)))},L2DPose.prototype.copyOpacityOtherParts=function(t,e){for(var i=0;i<e.length;i++){var r=e[i];if(null!=r.link&&!(r.partsIndex<0))for(var o=t.getPartsOpacity(r.partsIndex),a=0;a<r.link.length;a++){var s=r.link[a];s.partsIndex<0||t.setPartsOpacity(s.partsIndex,o)}}},L2DPartsParam.prototype.initIndex=function(t){this.paramIndex=t.getParamIndex("VISIBLE:"+this.id),this.partsIndex=t.getPartsDataIndex(PartsDataID.getID(this.id)),t.setParamFloat(this.paramIndex,1)},L2DTargetPoint.FRAME_RATE=30,L2DTargetPoint.prototype.setPoint=function(t,e){this.faceTargetX=t,this.faceTargetY=e},L2DTargetPoint.prototype.getX=function(){return this.faceX},L2DTargetPoint.prototype.getY=function(){return this.faceY},L2DTargetPoint.prototype.update=function(){var t,e,i,r,o,a,s,n,h,l,p,c,u=40/7.5/L2DTargetPoint.FRAME_RATE;0!=this.lastTimeSec?(e=((t=UtSystem.getUserTimeMSec())-this.lastTimeSec)*L2DTargetPoint.FRAME_RATE/1e3,this.lastTimeSec=t,i=e*u/(.15*L2DTargetPoint.FRAME_RATE),r=this.faceTargetX-this.faceX,o=this.faceTargetY-this.faceY,0==r&&0==o||(s=u*o/(a=Math.sqrt(r*r+o*o)),n=u*r/a-this.faceVX,h=s-this.faceVY,((l=Math.sqrt(n*n+h*h))<-i||i<l)&&(n*=i/l,h*=i/l,l=i),this.faceVX+=n,this.faceVY+=h,(p=.5*(Math.sqrt(i*i+16*i*a-8*i*a)-i))<(c=Math.sqrt(this.faceVX*this.faceVX+this.faceVY*this.faceVY))&&(this.faceVX*=p/c,this.faceVY*=p/c),this.faceX+=this.faceVX,this.faceY+=this.faceVY)):this.lastTimeSec=UtSystem.getUserTimeMSec()},L2DViewMatrix.prototype=new L2DMatrix44,L2DViewMatrix.prototype.getMaxScale=function(){return this.max},L2DViewMatrix.prototype.getMinScale=function(){return this.min},L2DViewMatrix.prototype.setMaxScale=function(t){this.max=t},L2DViewMatrix.prototype.setMinScale=function(t){this.min=t},L2DViewMatrix.prototype.isMaxScale=function(){return this.getScaleX()==this.max},L2DViewMatrix.prototype.isMinScale=function(){return this.getScaleX()==this.min},L2DViewMatrix.prototype.adjustTranslate=function(t,e){this.tr[0]*this.maxLeft+(this.tr[12]+t)>this.screenLeft&&(t=this.screenLeft-this.tr[0]*this.maxLeft-this.tr[12]),this.tr[0]*this.maxRight+(this.tr[12]+t)<this.screenRight&&(t=this.screenRight-this.tr[0]*this.maxRight-this.tr[12]),this.tr[5]*this.maxTop+(this.tr[13]+e)<this.screenTop&&(e=this.screenTop-this.tr[5]*this.maxTop-this.tr[13]),this.tr[5]*this.maxBottom+(this.tr[13]+e)>this.screenBottom&&(e=this.screenBottom-this.tr[5]*this.maxBottom-this.tr[13]);var i=[1,0,0,0,0,1,0,0,0,0,1,0,t,e,0,1];L2DMatrix44.mul(i,this.tr,this.tr)},L2DViewMatrix.prototype.adjustScale=function(t,e,i){var r=i*this.tr[0];r<this.min?0<this.tr[0]&&(i=this.min/this.tr[0]):r>this.max&&0<this.tr[0]&&(i=this.max/this.tr[0]);var o=[1,0,0,0,0,1,0,0,0,0,1,0,t,e,0,1],a=[i,0,0,0,0,i,0,0,0,0,1,0,0,0,0,1],s=[1,0,0,0,0,1,0,0,0,0,1,0,-t,-e,0,1];L2DMatrix44.mul(s,this.tr,this.tr),L2DMatrix44.mul(a,this.tr,this.tr),L2DMatrix44.mul(o,this.tr,this.tr)},L2DViewMatrix.prototype.setScreenRect=function(t,e,i,r){this.screenLeft=t,this.screenRight=e,this.screenTop=r,this.screenBottom=i},L2DViewMatrix.prototype.setMaxScreenRect=function(t,e,i,r){this.maxLeft=t,this.maxRight=e,this.maxTop=r,this.maxBottom=i},L2DViewMatrix.prototype.getScreenLeft=function(){return this.screenLeft},L2DViewMatrix.prototype.getScreenRight=function(){return this.screenRight},L2DViewMatrix.prototype.getScreenBottom=function(){return this.screenBottom},L2DViewMatrix.prototype.getScreenTop=function(){return this.screenTop},L2DViewMatrix.prototype.getMaxLeft=function(){return this.maxLeft},L2DViewMatrix.prototype.getMaxRight=function(){return this.maxRight},L2DViewMatrix.prototype.getMaxBottom=function(){return this.maxBottom},L2DViewMatrix.prototype.getMaxTop=function(){return this.maxTop},Live2DFramework.platformManager=null,Live2DFramework.getPlatformManager=function(){return Live2DFramework.platformManager},Live2DFramework.setPlatformManager=function(t){Live2DFramework.platformManager=t};